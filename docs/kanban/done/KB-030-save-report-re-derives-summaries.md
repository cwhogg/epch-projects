# KB-030: save_report tool re-derives summaries already computed in compare_weeks

- **Type:** simplification
- **Discovered during:** finishing-a-development-branch (code-simplifier)
- **Location:** `src/lib/agent-tools/analytics.ts:283-344`
- **Observed:** save_report (lines 291-306) recomputes totalClicks, totalImpressions, averagePosition, averageCtr, fetches previousSnapshots, and calls detectChanges — all of which compare_weeks (lines 193-222) already computed and returned to the agent. The agent is instructed to call compare_weeks before save_report, making the recalculation pure duplication of work and state.
- **Expected:** Have save_report accept the pre-computed summary data as input rather than re-deriving it
- **Why out of scope:** Simplification opportunity — not a bug or part of the current task
- **Severity:** HIGH
- **Created:** 2026-02-16

## Triage (2026-02-17)

- **Verdict:** REVISE
- **Evidence:** Confirmed at `src/lib/agent-tools/analytics.ts:291-306`. `save_report.execute` independently calls `getWeeklySnapshot(previousWeekId)` (line 302), reduces `cachedSnapshots` for `totalClicks`/`totalImpressions` (lines 291-292), and calls `detectChanges(cachedSnapshots, previousSnapshots)` (line 306) — all of which `compare_weeks.execute` (lines 194-196, 199-202) already computed. The duplication is real. However, `compare_weeks` also does NOT compute `averagePosition` or `averageCtr` (lines 293-298 in `save_report` — those are unique to `save_report`). The KB's proposed fix ("accept pre-computed summary data as input") is incorrect: the LLM receives truncated alert data from `compare_weeks` (only `{piece, severity, message}` per line 214-218), not the full `PerformanceAlert[]` that `addPerformanceAlerts` requires (`pieceSlug`, `metric`, `previousValue`, etc.). Passing alert data as tool input parameters cannot work.
- **Root Cause:** `save_report` was written defensively — it does not trust that `compare_weeks` was called, so it re-derives everything it needs from the shared closure cache (`cachedSnapshots`) rather than building on `compare_weeks` output. The two tools were written in parallel rather than as a pipeline. The closure already caches raw inputs (`cachedSnapshots`, `cachedWeekId`, `cachedSlugLookup`) but never caches the derived outputs of `compare_weeks` (`previousSnapshots`, `alerts`).
- **Risk Assessment:** No API response shape changes. `WeeklyReport` structure on disk is identical. No callers of the tool interface are affected. Adding closure-level caches (`cachedPreviousSnapshots`, `cachedAlerts`) is consistent with the existing closure pattern. If `save_report` is called without `compare_weeks`, the cached values are null — `save_report` must fall back to fetching to remain safe. There are no unit tests for `analytics.ts` execute functions, so no tests break; new tests should be added as part of the fix.
- **Validated Fix:** Do NOT change `save_report`'s input schema. Instead, cache `compare_weeks` derived outputs in the closure: (1) Add `let cachedPreviousSnapshots: PieceSnapshot[] | null = null` and `let cachedAlerts: PerformanceAlert[] | null = null` to the closure at `src/lib/agent-tools/analytics.ts:33-38`. (2) At the end of `compare_weeks.execute` (before `return`), assign `cachedPreviousSnapshots = previousSnapshots` and `cachedAlerts = alerts`. (3) In `save_report.execute`, replace the independent `getWeeklySnapshot` call (line 302) and `detectChanges` call (line 306) with reads from `cachedPreviousSnapshots ?? await getWeeklySnapshot(previousWeekId)` and `cachedAlerts ?? detectChanges(cachedSnapshots, previousSnapshots)` — retaining the fallback for safety. The `averagePosition` and `averageCtr` computations (lines 293-298) are unique to `save_report` and must remain. (4) Add tests for the `compare_weeks` → `save_report` pipeline to `src/lib/__tests__/analytics-agent.test.ts` or a new `src/lib/agent-tools/__tests__/analytics-tools.test.ts`.
- **Files Affected:** `src/lib/agent-tools/analytics.ts` (closure additions, compare_weeks populate, save_report reads cache); test file (new or extended)
- **Estimated Scope:** Small — ~15 lines changed in analytics.ts, ~30-50 lines of new tests
